{{- if and .Values.istio.enabled .Values.mirroring.enabled }}
# DestinationRule to define subsets
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ include "shadow-mirroring.fullname" . }}
  labels:
    {{- include "shadow-mirroring.labels" . | nindent 4 }}
spec:
  host: {{ include "shadow-mirroring.fullname" . }}
  subsets:
  - name: production
    labels:
      version: production
  - name: shadow
    labels:
      version: shadow
---
# VirtualService with traffic mirroring
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "shadow-mirroring.fullname" . }}
  labels:
    {{- include "shadow-mirroring.labels" . | nindent 4 }}
spec:
  hosts:
  - {{ include "shadow-mirroring.fullname" . }}
  http:
  - route:
    - destination:
        host: {{ include "shadow-mirroring.fullname" . }}
        subset: production
      weight: 100
    {{- if .Values.shadow.enabled }}
    mirror:
      host: {{ include "shadow-mirroring.fullname" . }}
      subset: shadow
    mirrorPercentage:
      value: {{ .Values.mirroring.percentage | float64 }}
    {{- end }}
{{- if .Values.istio.gateway.enabled }}
---
# Gateway for external access
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: {{ include "shadow-mirroring.fullname" . }}
  labels:
    {{- include "shadow-mirroring.labels" . | nindent 4 }}
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - {{ .Values.istio.gateway.host }}
---
# VirtualService for Gateway
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "shadow-mirroring.fullname" . }}-gateway
  labels:
    {{- include "shadow-mirroring.labels" . | nindent 4 }}
spec:
  hosts:
  - {{ .Values.istio.gateway.host }}
  gateways:
  - {{ include "shadow-mirroring.fullname" . }}
  http:
  - route:
    - destination:
        host: {{ include "shadow-mirroring.fullname" . }}
        subset: production
      weight: 100
    {{- if .Values.shadow.enabled }}
    mirror:
      host: {{ include "shadow-mirroring.fullname" . }}
      subset: shadow
    mirrorPercentage:
      value: {{ .Values.mirroring.percentage | float64 }}
    {{- end }}
{{- end }}
{{- end }}
